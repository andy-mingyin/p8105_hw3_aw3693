---
title: "Homework 3"
author: "Mingyin Wang"
date: 2024-10-08
output: github_document
---

```{r, echo=FALSE}
library(tidyverse)
library(patchwork)
library(patchwork)

```
Problem 1

```{r}
library(p8105.datasets)
data("ny_noaa")
```

Problem 2
load clean, and tidy data
```{r}
covar_df = read_csv("data/nhanes_covar.csv", skip = 4) |>
  janitor::clean_names() |>
  mutate(
      sex = recode(sex, "1" = "male", "2" = "female"),
      education = recode(education, "1" = "Less than high school", "2" = "High school equivalent", "3" = "More than high school"), 
    sex = factor(sex), 
    education = factor(education)
    )
clean_covar_df = covar_df |>
  filter(age >= 21) |>
  drop_na()

accel_df = read_csv("data/nhanes_accel.csv") |>
  janitor::clean_names() 

```
merge data frame

```{r}
merged_df =  accel_df |>
  inner_join(clean_covar_df, by = "seqn")
```

create a readable table

```{r}
education_sex_table = merged_df |>
  count(education, sex) |>
  spread(key = sex, value = n, fill = 0)
education_sex_table
```

 visualization of the age distributions for men and women in each education category.     
```{r}
ggplot(merged_df, aes(x = education, y = age, fill = sex)) +
  geom_boxplot() + 
  labs(title = "Age Distribution by Education and Sex", x = "Education Level", y = "Age") +
  theme_minimal() 

```

Create a total activity df
```{r}
tot_act = 
  merged_df |>
  mutate(total_activity = rowSums(select(merged_df, starts_with("min"))))

```

Plot total activity vs. age, comparing men and women by education level

```{r}
ggplot(tot_act, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~education) +
  labs(title = "Total Activity vs. Age by Education and Sex", x = "Age", y = "Total Activity") +
  theme_minimal()
```

pivot longer the df 
```{r}
day_df = tot_act |>
  pivot_longer(cols= starts_with("min"),
               names_prefix = "min",
               names_to = "minute",
               values_to = "mims") |> 
  mutate(minute = as.numeric(minute)) 

```

Make a three-panel plot that shows the 24-hour activity time courses for each education level
```{r}
ggplot(day_df, aes(x = minute, y = mims, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_wrap(~education) +
  labs(title = "24-Hour Activity Time Course by Education and Sex", x = "Minute of the Day", y = "Average MIMS") +
  theme_minimal()
```

Question 3

laod the datasets
```{r}
jan_2020 = read_csv("data/citibike/Jan 2020 Citi.csv") |>
  janitor::clean_names() |>
  mutate(year = 2020, month = 1)
jan_2024 = read_csv("data/citibike/Jan 2024 Citi.csv") |>
   janitor::clean_names() |>
  mutate(year = 2024, month = 1)
july_2020 = read_csv("data/citibike/July 2020 Citi.csv") |>
   janitor::clean_names() |>
  mutate(year = 2020, month = 7)
july_2024 = read_csv("data/citibike/July 2024 Citi.csv") |>
   janitor::clean_names() |>
 mutate(year = 2024, month = 7)
```

combine all data 
```{r}
combined_df = bind_rows(jan_2020, jan_2024, july_2020, july_2024)
combined_df
```

Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members.



```{r}
rides_summary = combined_df |>
  group_by(year, month, member_casual) |>
  summarize(total_rides = n(), .groups = 'drop') |>
  pivot_wider(names_from = member_casual, values_from = total_rides) |>
  mutate(total_rides_month = rowSums(across(c(casual, member), ~replace_na(., 0))))
rides_summary
```

Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.
```{r}
five_popular_stations = combined_df |>
  filter(year == 2024, month == 7) |>
  group_by(start_station_name) |>
  summarize(n_rides = n()) |>
  arrange(desc(n_rides)) |>
  head(5)
five_popular_stations
```

Make a plot to investigate the effects of day of the week, month, and year on median ride duration. 
```{r}
median_ride_duration = 
  combined_df |>
  group_by(year, month, weekdays) |>
  summarize(median_duration = median(duration, na.rm = TRUE), .groups = "drop")


ggplot(median_ride_duration, aes(x = weekdays, y = median_duration, color = factor(year))) +
  geom_line(aes(group = interaction(year, month)), size = 1) +  
  facet_wrap(~ month) +  
  labs(
    title = "Median Ride Duration by Day of the Week, Month, and Year",
    x = "Day of the Week",
    y = "Median Ride Duration (minutes)",
    color = "Year"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration.
```{r}
df_2024 =
  combined_df |> 
  filter(year == 2024) 

ggplot(df_2024, aes(x = duration, fill = rideable_type)) +
  geom_histogram(binwidth = 7, alpha = .4, position = "identity") +   
  facet_wrap(~ month + member_casual) +
  labs(title = "Distribution of Ride Duration by Month, Membership Status, and Bike Type in 2024",
       x = "Ride Duration (minutes)",
       y = "Count",
       fill = "Bike Type") +
  theme_minimal() 
```





```{r}
```


